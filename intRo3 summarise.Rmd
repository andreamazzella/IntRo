---
title: "3A: Subsetting data"
subtitle: "Introduction to R"
author: Andrea Mazzella [(GitHub)](https://github.com/andreamazzella)
---

-------------------------------------------------------------------------------

# What you will learn

* Data subsets with `dplyr`
 - Filtering rows
 - Selecting columns
 
* Conditions in R
 
* Pipes
 - `|>`

-------------------------------------------------------------------------------


```{r}
# Load packages
library(dplyr)
library(ggplot2)
```

*Want to know more?*
Conflict between packages: if two packages contain two functions with the same name, R will use the function from the package that you loaded last. If you want to force R to use the function from a specific package, you can preface the function with `packagename::`. For example, `dplyr::filter(...)` will tell R to specifically use the `filter()` function from `dplyr` (and not the one from `stats`).


-------------------------------------------------------------------------------

# Data subsets with `dplyr`

`dplyr` is a package that makes manipulating data easier.

In this session we'll focus on two main tasks for which this package is helpful: reducing rows (`filter()`) and reducing columns (`select()`). We'll continue to use dataset `msleep` from last session.

## Filter rows

Sometimes you don't need to use all the observations (rows) in your dataset, but only a group of those: for example, you might want to plot sleep duration only among herbivores.

The function `filter()` lets you do just that: it filters your dataset according to a condition.
Its first argument is the dataset name, just like function `ggplot()`.
Its second argument is a condition.

```{r}
# Only keep herbivores
filter(msleep, vore == "omni")
# note that it's a double = sign!
```

Note that now there are only 32 rows (down from 83) because all non-herbivores were excluded.

This is a temporary change. `msleep` stayed the same:
```{r}
msleep
```

If you want to keep a copy of a filtered dataset, you need to assign it a name.
```{r}
msleep_herbi <- filter(msleep, vore == "herbi")
```


You can use filtered data in a plot: you simply replace the dataset name with the new filtered dataset as the first `ggplot()` argument.

```{r}
# Plotting all mammals
ggplot(msleep,
       aes(sleep_rem, awake, colour = vore)) + geom_point()

# Plotting only herbivores
ggplot(filter(msleep, vore == "herbi"),
       aes(sleep_rem, awake, colour = vore)) + geom_point() +
  scale_colour_manual(values = "#7CAE00") + coord_cartesian(xlim = c(0, 6.5), ylim = c(4, 22)) # this line will make the two graphs more comparable
```

Common conditions in R:
`==` (NB: *two* equal signs) - can be used for numbers or text.
`!=`: different than - can be used for numbers or text.
`>`, `<`, `>=`, `<=` like in maths.
`is.na()` - is this a missing value?
`!is.na()` - is this a non-missing value?
`%in% c(3, 7)` - is this value present in this list?

For example, we can use `!is.na()` to only keep observation with non-missing sleep cycle data:
```{r}
filter(msleep, !is.na(sleep_cycle))
```


You can also filter on more than one condition; for example, you might want to only filter herbivores that sleep more than 15 hours a day.
```{r}
filter(msleep, vore == "herbi" & sleep_total > 15)
```

Linking two conditions:
`&`: and. The overall condition will be TRUE only if both conditions are TRUE.
`|`: or. The overall condition will be TRUE if either condition is TRUE.

*Exercise*
Filter domesticated mammals that weight more than 50 kg. Which are they?

```{r filter}
filter(msleep, conservation == "domesticated" & bodywt > 50)
```

*Exercise*
Make a bar chart of diet type, but only for mammals whose brain weighs less than 50 grams.

```{r}
ggplot(msleep, aes(vore)) + geom_bar()

ggplot(filter(msleep, brainwt < 50/1000), aes(vore)) + geom_bar()
```


-------------------------------------------------------------------------------

## Select columns

Function `select()` keeps only certain variables (columns), and removes the rest. The first argument is (again) the dataset name. All the other arguments are the names of the variables we want to keep.

Imagine we wanted a dataset containing only information about mammal `name` and `order`:

```{r}
select(msleep, name, order)
```

We can add as many variables as we need.

*Exercise*
Select only variables with brain and body weight, as well as mammal name.
```{r select}
select(msleep, name, brainwt, bodywt)
```



There are a number of functions to help us select more efficiently; for example, `starts_with()`:
```{r}
msleep |> select(name, starts_with("sleep"))
```


-------------------------------------------------------------------------------


# Pipes

In the chunk above you might have noticed a weird `|>`. What was that?

## `|>` pipe

The "native" R pipe is `|>`. It makes your code quicker to write and most importantly, easier to read.

The `|>` does this:
1. It takes what's on its left hand-side
2. It moves it inside the brackets in the function on its right hand-side
3. It adds a comma.

Examples:

```{r}
# Code with the pipe
msleep |> filter(order == "Primates")

# Code without the pipe
filter(msleep, order == "Primates")
```
In the chunk above, the `|>` pipe takes `msleep` and shifts it inside `filter()`, in first position, and then adds a comma.
It effectively makes `msleep` the first argument of `filter()`.

You might think that it's not particularly helpful in this case. However, it can simplify more complex code - for example, think about doing plots with an intermediate subsetting step. You have three options which produce the same result.

*Don't* run the chunk: focus on the syntax.
```{r}
# Option 1: nested functions
ggplot(filter(msleep, vore == "herbi"), aes(sleep_rem, awake, colour = vore)) +
  geom_point()

# Option 2: intermediate assignment
msleep_herbi <- filter(msleep, vore == "herbi")
ggplot(msleep_herbi, aes(sleep_rem, awake, colour = vore)) +
  geom_point()

# Option 3: piping
msleep |> 
  filter(vore == "herbi") |> 
  ggplot(aes(sleep_rem, awake, colour = vore)) +
  geom_point()
```
An explanation of the code above.
1. Make a plot of a filtered version of `msleep`. This makes code more difficult to read - you don't immediately understand which dataset is being plotted.
2. Create a new object called `msleep_herbi` and make it a filtered version of `msleep`. Then make a plot of `msleep_herbi`. This is clearer, but you risk ending up with a very busy Environment if you create a lot of new objects.
3. You take `msleep` *and then* you `filter()` it, *and then* you use that in a `ggplot()`.

*Exercise*
Rewrite this command using a pipe.
```{r}
# Code without a pipe
select(msleep, name)

# Code with a pipe

```

*Exercise*
Rewrite this command without the pipe.
```{r}
msleep |> filter(awake > 21)
```


You can combine `select()` and `filter()` by piping. For example, you might want to only focus on weight information for animals with missing `conservation` data. 
```{r}
msleep |>
  filter(is.na(conservation)) |> 
  select(name, ends_with("wt"))
```

-------------------------------------------------------------------------------

*Recap exercise*
1. Create a new dataset called `sleepy` containing only data on genus and order - just for insectivores who sleep at least 9 hours per day.
2. How many mammals satisfy these filters?
3. Which animal orders do they belong to?
```{r recap}
msleep |>
  filter(vore == "insecti" & sleep_total >= 13) |>
  select(name, genus, order)
```

-------------------------------------------------------------------------------

## When you can't use the native pipe

All packages in the `tidyverse` (`ggplot2`, `dplyr`, `tidyr`) and many others use this philosophy - the first argument of a function that uses data as input should be the dataset name. When this happens, you can use the pipe syntax.

Unfortunately, many R functions don't follow this philosophy.

For example, the function for linear regression, `lm()`, requires the formula as a first argument, and data as the second. You can't use the `|>` pipe for this.

Another example is the `table()` function. If you want to have a 2x2 table, its arguments need to be the columns as identified by the `$` operator, for example, `table(msleep$conservation, msleep$vore)`. This means that you can't use the native pipe: `msleep |> table(conservation, vore)` would transform into `table(msleep, conservation, vore)` which is not what the `table()` function is expecting.


-------------------------------------------------------------------------------

## Other pipes


You will sometimes see other pipes. The two more common ones are:
- `%>%` - in most circumstances it works the same as `|>`. It's very popular because it was created before `|>`.
- `%$%` - this is the equivalent of `|>` for functions that require columns to be identified with `$`.

I don't think it's important to know more about these pipes at this stage.

*But if you're a keen bean and want to know more...*

### `%>%` pipe

`%>%` is originally from package `magrittr` but it's also loaded whenever you use any `tidyverse` package.

It is slightly more flexible than `|>` because it can also push what's on the left to arguments of the function on the right *that are not in the first position* - you indicate the exact position with a place-holding dot.

```{r}
# Base R
lm(sleep_rem ~ brainwt, data = msleep)

# Pipe
msleep %>% lm(sleep_rem ~ brainwt, data = .)
```


### `%$%` pipe

You might remember the `$` operator, which extracts a variable from a dataset: `data$variable1` subsets the variable called `variable1` from the dataset `data`.
```{r}
msleep$vore
```

We use this syntax when a function requires a variable (and not the whole dataset); for example, if we want to get the frequencies, we can use the syntax below.
```{r}
table(msleep$vore)
```

The `%$%` pipe, from package `magrittr`, takes what's on its left (usually, the dataset name) and moves it inside the function, before each argument, and adds a `$` in between. It lets you avoid typing the dataset name and `$` twice, and it makes the true arguments of the function stand out.
It's particularly useful when a function uses multiple variables, because otherwise you would need to specify which dataset is each variable from â€“ this would quickly become verbose.
The two commands below generate the same output.
```{r}
# Without a pipe (= base R)
table(msleep$conservation, msleep$vore)

# With the %$% pipe
library(magrittr)
msleep %$% table(conservation, vore)
```

-------------------------------------------------------------------------------



# Solutions



-------------------------------------------------------------------------------
