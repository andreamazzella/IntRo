---
title: "2: Data import and visualisation"
subtitle: "Introduction to R"
author: Andrea Mazzella [(GitHub)](https://github.com/andreamazzella)
---

-------------------------------------------------------------------------------

# What you will learn

* Using packages
 
* Data exploration

* Data visualisation with `ggplot2`
 - Bar charts
 - Histograms
 - Scatterplots
 - Saving a plot

-------------------------------------------------------------------------------

# Using packages

R has some core functions, like the ones we've used so far: `sqrt()`, `mean()`, `table()` and some more advanced ones (for example, the function for logistic regression). There are also extra functions made by programmers and grouped into "packages", which need to be downloaded (and loaded) separately.

## Step 1: Download and install a package

To download and install a package, one uses the `install.packages()` function, adding the package name in quotes. This might take a bit of time if the packages are large.
```{r}
install.packages("ggplot2")
```

You may also do this via the RStudio user interface: in the bottom right quarter of the screen, you click on `Packages` and then `Install`. You type the name of the package in the empty field and then click on the `Install` button.

*Exercise*
Install package `dplyr` with either method.


## Step 2: Load a package

You can then load (open) the package with `library()` so that you can use its functions.
```{r}
library(ggplot2)
```

You only need to install packages once, but you then need to open it every time you want to use some of its functions. So, when you create a new R script or notebook, you always start with one `library()` call for each package that you will use.

-------------------------------------------------------------------------------

# Data exploration

For this session we will use a sample dataset called `msleep`.

It contains data on sleep for 83 different mammal species.

```{r}
# Preview of dataset
msleep

# RStudio Viewer
View(msleep)

# More information
help(msleep)
```

-------------------------------------------------------------------------------

# Data visualisation with `ggplot2`

Package `ggplot2` can make stunning graphs â€“ plotting is one of the areas in which R shines.
It works in "layers" separated by `+` signs: you can have a very simple graph with just two layers, or a very complex one with many more.
Let's start with something simple and work on it.

-------------------------------------------------------------------------------

## Bar charts

Bar charts are useful to visualise frequencies of a categorical variable, such as diet type in our dataset (`vore`). (Say NO to pie charts!)

They are made by using `geom_bar()`. This is how to make a basic bar chart in `ggplot2`:
```{r}
# You start with the dataset and variable to plot
ggplot(msleep, aes(x = vore)) +
  # You then add the type of graph
  geom_bar()
```
Let's break this code down.
* `ggplot()` is the base function: it needs as arguments:
 - the dataset name (`msleep`)
 - `aes()` stands for "aesthetics", and basically means what we want to appear on the graph. `x = vore` means that we want variable `vore` to be plotted on the x-axis.
* `geom_bar` is a geometry function: it specifies that we want the variable above to be represented in a bar chart.
* The `+` sign links the base function with the geometry function.

Note that code can span over more than one line - it makes it more readible.

### Bugs 

Computers take your instructions very literally, so tiny mistakes can easily break some code.

*Debugging exercise*
This chunk won't execute. Can you spot the *three* bugs that break the code, and fix them?

```{r exercise2}
ggplot(msleep, aes(x = Vore)
  geom_bar()
```
(Hint: RStudio will *sometimes* help with some of these bugs. Look at the left of the chunk. Sometimes the advice can actually be misleading, so take with a pinch of salt).

*Exercise*
Visualise the conservation status of the mammals in this dataset with a bar chart.
Hint: you can run the dataset name if you don't know what the variables are called.
```{r exercise1}

```

### Colour as decoration
 
We can build on these simple graphs by adding some optional arguments.
 
For example, let's change the fill colour from the default gray.
 
```{r histogram3}
ggplot(msleep, aes(x = vore)) +
  geom_bar(fill = "darkgreen")
```

### Colour that conveys information

However colour can also be use to convey information - for example, to stratify a plot by a categorical variable.

To do this, we add `fill` to the `aes()` function, rather than keeping it outside of it, and we link it to a variable name, rather than to a specific colour. This will also add a legend.

```{r histogram3}
ggplot(msleep, aes(x = vore, fill = conservation)) +
  geom_bar()
```


### Changing value labels

We can further customise the graph by adding more *layers*: you add a `+` at the end of a line and then add more functions.

For example, let's change the value labels for the categorical variables so that they are more easily understandable.

- in the axes, by using `scale_x_discrete()`;
- in the `fill` legend, by using `scale_fill_discrete()`.

```{r}
ggplot(msleep, aes(x = vore, fill = conservation)) +
  geom_bar() +
  scale_x_discrete(labels = c("carni" = "Carnivore",
                              "herbi" = "Herbivore",
                              "insecti" = "Insectivore",
                              "omni" = "Omnivore")) +
  scale_fill_discrete(labels = c("cd" = "conservation-dependent",
                                 "en" = "endangered",
                                 "lc" = "least concern",
                                 "nt" = "near threatened",
                                 "vu" = "vulnerable"
                                 ))
```

*Exercise*
Now create the opposite bar chart: get count numbers for conservation, stratified by diet type.
```{r}

```

-------------------------------------------------------------------------------

## Histograms

Histograms are helpful when we want to check the distribution of a continuous variable - for example, hours of sleep.

The simplest histogram we can draw with `ggplot2` is this:
 
```{r histogram1}
ggplot(msleep, aes(x = sleep_total)) +
  geom_histogram()
```
### Bins

A histogram is similar to a bar chart, but it first needs to cut the continuous variable into "bins". By default, `geom_histogram()` uses 30 bins, but you can customise it by adding a `bins =`value. Or you can say how wide each bin should be, with `binwidth =`.

```{r}
ggplot(msleep, aes(x = sleep_total)) +
  geom_histogram(bins = 10)
```


### Labels

Now let's add a plot title and rename the axes.

You do this by adding another `+` sign and then the `labs()` function - which can include a `title =`, `x =`, `subtitle =`, `caption =`...

```{r histogram2}
ggplot(msleep, aes(x = sleep_total)) +
  geom_histogram() +
  labs(title = "Daily hours of sleep among 83 mammal species",
       x = "Sleep duration (h)")
```
 
*Exercise*

- Make a new histogram of a continuous variable of your choice.
- Change the number of bins.
- Rename the x-axis appropriately.
- Add a title.

Hint: do it layer by layer, so that if it doesn't work, you can try and fix it more easily, before making it very complex.
```{r}
# Dataframe and variable

# Graph type and bins

# Labels for x-axis and title

```

-------------------------------------------------------------------------------


## Scatterplots

You can plot two continuous variables against each other in a scatterplot.
The function is `geom_point()`; a basic scatterplot is made this way:
```{r}
ggplot(msleep, aes(x = sleep_total, y = sleep_rem)) +
  geom_point()
```

*Exercise*
Add a title and rename the axes on the scatterplot above.
```{r}

```


We can also stratify by a categorical variable thanks to the `colour` aesthetic.
```{r}
ggplot(msleep, aes(x = sleep_total, y = sleep_rem)) +
  geom_point(aes(colour = vore))
```

*Exercise*
Show different diet types (`vore`) with different *shapes*, rather than different colours.
```{r}

```

### More customisation

`ggplot2` allows you to customise your graphs to a great extent. 

Run this chunk and then try to understand what each line does. 
```{r}
  ggplot(msleep, aes(x = sleep_total, y = sleep_rem)) +
  geom_smooth(method = "lm", colour = "darkgrey", linetype = "dashed") +
  geom_point(aes(shape = vore, colour = conservation)) +
  labs(title = "Relationship between total and REM sleep duration",
       subtitle = "Among 83 mammal species",
       x = "Daily hours of sleep",
       y = "Daily hours of REM sleep",
       colour = "Conservation\nstatus",
       shape = "Diet type",
       caption = "Data: Savage & West 2007, 'A quantitative, theoretical framework for understanding mammalian sleep'"
       ) +
  theme_bw() +
  scale_colour_brewer(palette  = "Dark2")
```

-------------------------------------------------------------------------------

## Saving a plot

You can save a plot with function `ggsave()`. You need to specify the name of the file and its extension.
By default, it will save:
- the last plot you've generated
- into the current directory (i.e. the same directory as this .Rmd file).
```{r}
ggsave("REM_mammals_scatterplot.png")
```
You can save to pdf, jpeg, png, svg, and other formats, and you can change height and width. See `help(ggsave)` for more options.


-------------------------------------------------------------------------------

## Want more `ggplot2`?

I recommend these resources:

* (Basics) R for Data Science, [chapter 3: Data visualisation](https://r4ds.had.co.nz/data-visualisation.html)
* (Intermediate) The BBC Visual and Data Journalism cookbook for R graphics [link](https://bbc.github.io/rcookbook/)
* (Advanced) Data Visualisation with R, by Rob Kabacoff [link](https://rkabacoff.github.io/datavis/)
* RStudio Data Visualisation Cheat Sheet [link](https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf)


-------------------------------------------------------------------------------

## Solutions



-------------------------------------------------------------------------------
